<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../data-loader/data-loader.html">
<link rel="import" href="../bar-chart/bar-chart.html">
<link rel="import" href="../cumulated-chart/cumulated-chart.html">
<link rel="import" href="../distribution-chart/distribution-chart.html">
<link rel="import" href="../../bower_components/px-datetime-picker/px-datetime-picker.html">
<link rel="import" href="../../bower_components/px-tabs/px-tabs.html">
<link rel="import" href="../../bower_components/px-vis-timeseries/px-vis-timeseries.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<script src="../../bower_components/chart.js/dist/Chart.bundle.min.js"></script>
<script src="../data_handling.js"></script>

<dom-module id="screen-on-app">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <h2>Screen-On - how much are you using your phone?</h2>
    <data-loader on-data-received="fill_table"></data-loader>
  <px-datetime-picker 
    hide-time
    hide-presets
    show-buttons
    block-future-dates
    show-field-titles
    date-format="YYYY/MM/DD"
    min-date="[[min_date]]"
    max-date="[[max_date]]"
    on-moment-obj-changed="update_selected_day"
  ></px-datetime-picker>
      <div style="height: fit-content">
	      <!-- <bar-chart data="[[grouped_per_day]]"></bar-chart> -->

      </div>
      <div>
         <px-tabs selected="{{selected_chart}}">
             <px-tab id="tab2">Screen changes</px-tab>
           <px-tab id="tab1">Cumulated phone usage</px-tab>
           <px-tab id="tab3">Distribution of phone usage</px-tab>
         </px-tabs>
         <iron-pages selected="[[selected_chart]]">
           <div id="tab1-content" style="height: 600px">
             <cumulated-chart data="[[cumulated_per_day]]"></cumulated-chart>
           </div>
             <div id="tab2-content" style="height: 600px">
 <px-vis-timeseries
         chart-data="[[chartData]]"
	 height="350"
         show-tooltip
         hide-register
         series-config="[[seriesConfig]]">
      </px-vis-timeseries>
             </div>
           <div id="tab3-content" style="height: 600px">
             <distribution-chart data="[[distribution_per_day]]"></distribution-chart>
           </div>
         </iron-pages>
       </div>
    </template>
  <script>
    /**
     * @customElement
     * @polymer
     */
    class ScreenOnApp extends Polymer.Element {
      static get is() { return 'screen-on-app'; }
      static get properties() {
        return {
	    grouped_per_day: {
	        type: Array, value: []
	    },
            selected_chart: {
	        type: String, value: "tab2"
            }
	};
      }

      fill_table(evt) {
        console.log(evt);
        this.formatted_json = evt.detail;
        this.min_date = moment.unix(evt.detail[0].instant);
        this.max_date = moment.unix(evt.detail[evt.detail.length-1].instant).add(1, "day");
        this.grouped_per_day = group_by_day(evt.detail);
        const x = this.grouped_per_day.map(entry => {
            const day = entry.interval;
            const cumulated = cumulated_time(filter_by_day(this.formatted_json, day));
            return cumulated[cumulated.length-1];
        });
	      this.chartData = this.grouped_per_day.map((entry, i) => {
	          console.log("chart data", x[i]);
		       return {interval: moment(entry.interval, "YYYY MM DD").valueOf(), value: entry.value, cumulated: x[i].value};
		     });;
	this.seriesConfig = {
        "value": {name:"daily screen changes", x: "interval", y: "value", "axis":{"id":"axis1","side":"left","number":"1"}},
	    "cumulated": {name:"daily screen usage", x: "interval", y: "cumulated", "axis":{"id":"axis2","side":"right","number":"2"}, color: "orange"}
	}
      }

      fill_cumulated(evt) {
        const index = evt.detail.index;
	const day = this.grouped_per_day[index].interval;
        this.cumulated_per_day = cumulated_time(filter_by_day(this.formatted_json, day));
      }

      fill_distribution(evt) {
        const index = evt.detail.index;
	const day = this.grouped_per_day[index].interval;
        this.distribution_per_day = duration_distribution(filter_by_day(this.formatted_json, day));
      }

      update_selected_day(evt) {
          console.log("update selected day", evt, evt.detail);
	  const index = this.grouped_per_day.findIndex(d => d.interval === evt.detail.value.format("YYYY MM DD"));
	  if(index !== -1) {
              this.fill_cumulated({detail: {index: index}}); 
              this.fill_distribution({detail: {index: index}}); 
	  }
      }
    }

    window.customElements.define(ScreenOnApp.is, ScreenOnApp);
  </script>
</dom-module>
